name: Forge Learning Bot

on:
  schedule:
    # Every day at 00:05 UTC
   - cron: "5 0-23 1-31 1-12 0-6"
  workflow_dispatch:

jobs:
  forge-bot:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Foundry
        run: |
          # Download and install Foundry installer
          curl -L https://foundry.paradigm.xyz | bash
          
          # Install Foundry binaries (forge, cast, anvil, etc.)
          ~/.foundry/bin/foundryup

          # Add Foundry to PATH for this step
          export PATH="$HOME/.foundry/bin:$PATH"

          # Check versions
          forge --version
          cast --version

      - name: Create or Update Project
        run: |
          export PATH="$HOME/.foundry/bin:$PATH"

          if [ ! -d "contracts" ]; then
            forge init --no-git
          fi

          DATE=$(date +"%Y-%m-%d")
          FILE="contracts/Sample_$DATE.sol"

          echo "// SPDX-License-Identifier: MIT" > $FILE
          echo "pragma solidity ^0.8.20;" >> $FILE
          echo "" >> $FILE
          echo "contract Sample$DATE {" >> $FILE
          echo "    function ping() external pure returns (string memory) {" >> $FILE
          echo "        return \"hello from $DATE\";" >> $FILE
          echo "    }" >> $FILE
          echo "}" >> $FILE

      - name: Run tests
        run: |
          export PATH="$HOME/.foundry/bin:$PATH"
          forge test || true

      - name: Commit changes
        run: |
          git config user.name "forge-learning-bot"
          git config user.email "bot@users.noreply.github.com"

          git add .
          git commit -m "chore: generate Foundry sample for $(date +'%Y-%m-%d')" || exit 0
          git push
